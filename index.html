<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis & Simulasi Klaim</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
        }
        .container {
            max-width: 1200px;
            background-color: #FFFFFF;
        }
        .header {
            background-color: #1e3a8a; /* blue-900 */
            color: white;
        }
        input, select {
            border-radius: 0.375rem;
            border: 1px solid #d1d5db; /* gray-300 */
        }
        .summary-card {
            background-color: #f1f5f9; /* slate-100 */
            border: 1px solid #e2e8f0; /* slate-200 */
            padding: 1rem;
            border-radius: 0.5rem;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto p-6 md:p-8 rounded-2xl shadow-lg border border-gray-200">
        <div class="header p-6 rounded-xl mb-6 text-center">
            <h1 class="text-3xl md:text-4xl font-bold">Analisis & Simulasi Klaim</h1>
            <p class="text-blue-200 mt-2 text-sm">made by cah lanang josjis</p>
        </div>
        
        <div id="info-box" class="p-4 mb-6 rounded-lg bg-blue-50 border border-blue-200 text-blue-800 text-sm">
            <h3 class="font-semibold mb-2">Petunjuk Penggunaan:</h3>
            <p>Pastikan file Excel (XLSX) atau CSV Anda memiliki kolom dengan nama berikut (tidak case-sensitive): <strong>Umur, BMI, Jumlah Anak, Status Perokok, Gender, Region,</strong> dan kolom yang mengandung kata <strong>'Klaim'</strong>.</p>
        </div>

        <div id="parameters-section" class="mb-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Simulation Parameters -->
                <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Input Parameter Simulasi</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="deductibleInput" class="block text-sm font-medium text-gray-700">Deductible ($)</label>
                            <input type="number" id="deductibleInput" value="100" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="coInsuranceRateInput" class="block text-sm font-medium text-gray-700">Co-insurance Rate (%)</label>
                            <input type="number" id="coInsuranceRateInput" value="10" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="coInsuranceMaxInput" class="block text-sm font-medium text-gray-700">Co-insurance Max ($)</label>
                            <input type="number" id="coInsuranceMaxInput" value="500" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="reinsuranceRetentionInput" class="block text-sm font-medium text-gray-700">Reinsurance Retention ($)</label>
                            <input type="number" id="reinsuranceRetentionInput" value="10000" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="reinsuranceCoverInput" class="block text-sm font-medium text-gray-700">Reinsurance Cover (%)</label>
                            <input type="number" id="reinsuranceCoverInput" value="90" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="reimbursementCapInput" class="block text-sm font-medium text-gray-700">Reimbursement Cap ($)</label>
                            <input type="number" id="reimbursementCapInput" value="25000" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="minMonthlyPremiumInput" class="block text-sm font-medium text-gray-700">Premi Bulanan Min ($)</label>
                            <input type="number" id="minMonthlyPremiumInput" value="100" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="maxMonthlyPremiumInput" class="block text-sm font-medium text-gray-700">Premi Bulanan Max ($)</label>
                            <input type="number" id="maxMonthlyPremiumInput" value="500" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="discountRateInput" class="block text-sm font-medium text-gray-700">Discount Rate (%)</label>
                            <input type="number" id="discountRateInput" value="8" class="mt-1 block w-full p-2 text-sm">
                        </div>
                    </div>
                </div>
                <!-- Exclusion Parameters -->
                <div class="p-4 rounded-lg border border-gray-200 bg-gray-50">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Parameter Pengecualian Klaim</h2>
                    <p class="text-sm text-gray-600 mb-4">Atur batas untuk mengecualikan polis dari analisis. Biarkan kosong untuk tidak menerapkan filter.</p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label for="excludeAgeInput" class="block text-sm font-medium text-gray-700">Kecualikan Umur di Atas</label>
                            <input type="number" id="excludeAgeInput" placeholder="e.g., 55" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div>
                            <label for="excludeBmiInput" class="block text-sm font-medium text-gray-700">Kecualikan BMI di Atas</label>
                            <input type="number" id="excludeBmiInput" placeholder="e.g., 35" step="0.1" class="mt-1 block w-full p-2 text-sm">
                        </div>
                        <div class="sm:col-span-2">
                            <label for="excludeSmokerInput" class="block text-sm font-medium text-gray-700">Kecualikan Perokok</label>
                            <select id="excludeSmokerInput" class="mt-1 block w-full p-2 text-sm">
                                <option value="no">Tidak</option>
                                <option value="yes">Ya</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-center mt-6">
            <input type="file" id="fileInput" accept=".xlsx, .xls, .csv" class="mb-4 p-2 border rounded-md w-full max-w-md text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            <button onclick="startAnalysis()" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors duration-300 shadow-md">
                Mulai Analisis
            </button>
        </div>

        <div id="loading" class="mt-6 hidden text-center">
            <p class="text-blue-600">Memproses data, mohon tunggu...</p>
        </div>
        <div id="error-alert" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg" role="alert"></div>

        <div id="main-content" class="hidden mt-8 space-y-8">
            <div id="exclusion-summary" class="hidden p-4 rounded-lg bg-yellow-50 border border-yellow-300 text-yellow-800 text-sm"></div>
            
             <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div id="analysis-section" class="p-6 rounded-lg border bg-white">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Ringkasan Statistik Awal</h2>
                    <div id="statistical-summary" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                </div>
                <div class="p-6 rounded-lg border bg-white flex flex-col items-center justify-center">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800 text-center">Distribusi Polis per Region</h2>
                    <div class="w-full max-w-xs mx-auto">
                        <canvas id="regionChart"></canvas>
                    </div>
                </div>
             </div>

             <div class="p-6 rounded-lg border bg-white">
                 <h2 class="text-xl font-semibold mb-4 text-gray-800">Distribusi Frekuensi Klaim</h2>
                 <canvas id="claimsHistogram"></canvas>
             </div>
             
             <div id="output" class="p-6 rounded-lg border bg-white">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Hasil Simulasi & Model</h2>
                <div id="simulation-summary"></div>
                
                <h2 class="text-xl font-semibold mt-8 mb-4 text-gray-800">Tabel Hasil Simulasi Klaim (Top 100)</h2>
                <div id="results-table-container" class="max-h-[500px] overflow-y-auto border rounded-lg"></div>
             </div>
        </div>

        <div id="calculator-section" class="hidden p-6 rounded-lg border bg-white mt-8">
            <h2 class="text-xl font-semibold text-gray-800 mb-2">Kalkulator Premi Individu</h2>
            <p class="text-gray-600 mb-4 text-sm">Masukkan data pemegang polis untuk menghitung premi yang diprediksi berdasarkan model.</p>
            <div id="individual-loading" class="hidden text-center text-blue-600 mb-4">Menghitung...</div>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="individualAge" class="block text-sm font-medium text-gray-700">Umur</label>
                    <input type="number" id="individualAge" class="mt-1 block w-full p-2 text-sm" placeholder="e.g., 25">
                </div>
                <div>
                    <label for="individualBMI" class="block text-sm font-medium text-gray-700">BMI</label>
                    <input type="number" id="individualBMI" step="0.01" class="mt-1 block w-full p-2 text-sm" placeholder="e.g., 22.5">
                </div>
                <div>
                    <label for="individualChildren" class="block text-sm font-medium text-gray-700">Jumlah Anak</label>
                    <input type="number" id="individualChildren" class="mt-1 block w-full p-2 text-sm" placeholder="e.g., 1">
                </div>
                <div>
                    <label for="individualSmoker" class="block text-sm font-medium text-gray-700">Status Perokok</label>
                    <select id="individualSmoker" class="mt-1 block w-full p-2 text-sm">
                        <option value="no">Tidak</option>
                        <option value="yes">Ya</option>
                    </select>
                </div>
                <div>
                    <label for="individualGender" class="block text-sm font-medium text-gray-700">Gender</label>
                    <select id="individualGender" class="mt-1 block w-full p-2 text-sm">
                        <option value="female">Perempuan</option>
                        <option value="male">Laki-laki</option>
                    </select>
                </div>
                <div>
                    <label for="individualRegion" class="block text-sm font-medium text-gray-700">Region</label>
                    <select id="individualRegion" class="mt-1 block w-full p-2 text-sm">
                        <option value="southwest">Southwest</option>
                        <option value="northeast">Northeast</option>
                        <option value="northwest">Northwest</option>
                        <option value="southeast">Southeast</option>
                    </select>
                </div>
            </div>
            <button onclick="calculateIndividualPremium()" class="mt-4 w-full px-4 py-2 bg-blue-600 text-white font-bold rounded-lg hover:bg-blue-700 transition-colors">
                Hitung Premi
            </button>
            <div id="individual-result" class="hidden mt-4 p-4 rounded-md bg-blue-50 text-gray-700 border border-blue-200">
                <h3 class="text-md font-semibold text-gray-800">Hasil Premi yang Diprediksi</h3>
                <ul class="list-disc ml-5 space-y-1 text-sm">
                    <li id="predicted-monthly-premium">Premi Bulanan:</li>
                    <li id="predicted-annual-premium">Premi Tahunan:</li>
                </ul>
            </div>
        </div>

    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let betaCoefficients = null;
        let regionChartInstance = null;
        let claimsHistogramInstance = null;

        function showAlert(message) {
            const alertDiv = document.getElementById('error-alert');
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
        }
        
        function formatCurrency(value) {
            if (typeof value !== 'number' || isNaN(value)) {
                return '$0.00';
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(value);
        }
        
        function calculateAndDisplayStats(data, header) {
            const values = data.map(row => parseFloat(row[header])).filter(val => !isNaN(val));
            if (values.length === 0) {
                return `<div class="p-4 bg-gray-50 rounded-lg"><h3 class="font-medium text-gray-800 text-sm">Statistik ${header}:</h3><p class="text-gray-600 text-xs">Tidak ada data numerik.</p></div>`;
            }

            const totalCount = values.length;
            const mean = values.reduce((sum, val) => sum + val, 0) / totalCount;
            const min = Math.min(...values);
            const max = Math.max(...values);
            
            const squaredDifferences = values.map(val => Math.pow(val - mean, 2));
            const variance = squaredDifferences.reduce((sum, val) => sum + val, 0) / (totalCount > 1 ? totalCount - 1 : 1);
            const stdDev = Math.sqrt(variance);

            const isCurrency = header.toLowerCase().includes('klaim');

            return `
                <div class="p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-medium text-gray-800 text-sm">${header}</h3>
                    <ul class="mt-2 space-y-1 text-gray-600 text-xs">
                        <li><strong>Jumlah:</strong> ${totalCount}</li>
                        <li><strong>Rata-rata:</strong> ${isCurrency ? formatCurrency(mean) : mean.toFixed(2)}</li>
                        <li><strong>Min:</strong> ${isCurrency ? formatCurrency(min) : min.toFixed(2)}</li>
                        <li><strong>Max:</strong> ${isCurrency ? formatCurrency(max) : max.toFixed(2)}</li>
                        <li><strong>Simp. Baku:</strong> ${isCurrency ? formatCurrency(stdDev) : stdDev.toFixed(2)}</li>
                    </ul>
                </div>
            `;
        }

        function getLinearRegressionCoefficients(data) {
            const featureNames = ['Intercept', 'Umur', 'BMI', 'Jumlah Anak'];
            const hasSmokerVariance = new Set(data.map(r => String(r['Status Perokok']).toLowerCase().includes('yes'))).size > 1;
            const hasGenderVariance = new Set(data.map(r => String(r.Gender).toLowerCase())).size > 1;
            const regionValues = [...new Set(data.map(r => String(r.Region).toLowerCase()))];
            const hasRegionVariance = regionValues.length > 1;

            if (hasSmokerVariance) featureNames.push('Status Perokok (Ya)');
            if (hasGenderVariance) featureNames.push('Gender (Pria)');
            if (hasRegionVariance) {
                // Set a consistent baseline region, e.g., the first one alphabetically
                regionValues.sort();
                for (let i = 1; i < regionValues.length; i++) {
                    featureNames.push(`Region (${regionValues[i]})`);
                }
            }

            const X = data.map(row => {
                const features = [1, row.Umur, row.BMI, row['Jumlah Anak']];
                if (hasSmokerVariance) features.push(String(row['Status Perokok']).toLowerCase().includes('yes') ? 1 : 0);
                if (hasGenderVariance) features.push(String(row.Gender).toLowerCase() === 'male' ? 1 : 0);
                if (hasRegionVariance) {
                    for (let i = 1; i < regionValues.length; i++) {
                        features.push(String(row.Region).toLowerCase() === regionValues[i] ? 1 : 0);
                    }
                }
                return features;
            });

            const Y = data.map(row => row['Besar Klaim']);
            const m = X[0].length;
            const n = X.length;
            
            const X_t = Array(m).fill(0).map(() => Array(n).fill(0));
            for (let i = 0; i < n; i++) for (let j = 0; j < m; j++) X_t[j][i] = X[i][j];

            const X_t_X = Array(m).fill(0).map(() => Array(m).fill(0));
            for (let i = 0; i < m; i++) for (let j = 0; j < m; j++) for (let k = 0; k < n; k++) X_t_X[i][j] += X_t[i][k] * X[k][j];
            
            function inverse(M) {
                const size = M.length;
                const aug = M.map((row, i) => [...row, ...Array(size).fill(0).map((_, j) => i === j ? 1 : 0)]);
                for (let i = 0; i < size; i++) {
                    let pivotRow = i;
                    for (let k = i + 1; k < size; k++) if (Math.abs(aug[k][i]) > Math.abs(aug[pivotRow][i])) pivotRow = k;
                    [aug[i], aug[pivotRow]] = [aug[pivotRow], aug[i]];
                    const pivot = aug[i][i];
                    if (Math.abs(pivot) < 1e-9) return null;
                    for (let j = i; j < size * 2; j++) aug[i][j] /= pivot;
                    for (let k = 0; k < size; k++) if (k !== i) {
                        const factor = aug[k][i];
                        for (let j = i; j < size * 2; j++) aug[k][j] -= factor * aug[i][j];
                    }
                }
                return aug.map(row => row.slice(size));
            }

            const X_t_X_inv = inverse(X_t_X);
            if (!X_t_X_inv) return null;

            const X_t_Y = Array(m).fill(0);
            for (let i = 0; i < m; i++) for (let j = 0; j < n; j++) X_t_Y[i] += X_t[i][j] * Y[j];
            
            const beta = Array(m).fill(0);
            for (let i = 0; i < m; i++) for (let j = 0; j < m; j++) beta[i] += X_t_X_inv[i][j] * X_t_Y[j];

            const result = {};
            featureNames.forEach((name, index) => result[name] = beta[index]);
            return result;
        }
        
        function predictClaim(umur, bmi, children, isSmoker, gender, region) {
            if (!betaCoefficients) return 0;
            
            let predictedClaimValue = betaCoefficients['Intercept'] || 0;
            predictedClaimValue += (betaCoefficients['Umur'] || 0) * umur;
            predictedClaimValue += (betaCoefficients['BMI'] || 0) * bmi;
            predictedClaimValue += (betaCoefficients['Jumlah Anak'] || 0) * children;
            
            if (betaCoefficients['Status Perokok (Ya)']) {
                predictedClaimValue += (isSmoker.toLowerCase() === 'yes' ? betaCoefficients['Status Perokok (Ya)'] : 0);
            }
            if (betaCoefficients['Gender (Pria)']) {
                predictedClaimValue += (gender.toLowerCase() === 'male' ? betaCoefficients['Gender (Pria)'] : 0);
            }
            
            for (const key in betaCoefficients) {
                if (key.startsWith('Region (') && key.includes(region.toLowerCase())) {
                    predictedClaimValue += betaCoefficients[key];
                }
            }
            
            return Math.max(0, predictedClaimValue);
        }

        async function startAnalysis() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            const loadingDiv = document.getElementById('loading');
            const errorAlertDiv = document.getElementById('error-alert');
            const mainContentDiv = document.getElementById('main-content');
            const calculatorSection = document.getElementById('calculator-section');
            const exclusionSummaryDiv = document.getElementById('exclusion-summary');

            errorAlertDiv.style.display = 'none';
            mainContentDiv.style.display = 'none';
            calculatorSection.style.display = 'none';
            loadingDiv.style.display = 'block';

            if (!file) {
                showAlert("Silakan unggah file terlebih dahulu.");
                loadingDiv.style.display = 'none';
                return;
            }

            try {
                const fileType = file.name.split('.').pop().toLowerCase();
                let jsonData;

                if (fileType === 'csv') {
                    const csvText = await file.text();
                    jsonData = Papa.parse(csvText, { header: true, dynamicTyping: true, skipEmptyLines: true, transformHeader: h => h.trim() }).data;
                } else if (['xlsx', 'xls'].includes(fileType)) {
                    const data = new Uint8Array(await file.arrayBuffer());
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    jsonData = XLSX.utils.sheet_to_json(worksheet);
                } else {
                    showAlert("Format file tidak didukung. Silakan unggah file CSV atau XLSX.");
                    loadingDiv.style.display = 'none';
                    return;
                }

                if (jsonData.length === 0) {
                    showAlert("File tidak mengandung data atau kosong.");
                    loadingDiv.style.display = 'none';
                    return;
                }

                jsonData = jsonData.map(row => {
                    const newRow = {};
                    for (const key in row) {
                        let newKey = key.trim();
                        if (newKey.toLowerCase().includes('klaim')) newKey = 'Besar Klaim';
                        else if (newKey.toLowerCase() === 'umur') newKey = 'Umur';
                        else if (newKey.toLowerCase() === 'bmi') newKey = 'BMI';
                        else if (newKey.toLowerCase() === 'jumlah anak') newKey = 'Jumlah Anak';
                        else if (newKey.toLowerCase() === 'status perokok') newKey = 'Status Perokok';
                        else if (newKey.toLowerCase() === 'gender') newKey = 'Gender';
                        else if (newKey.toLowerCase() === 'region') newKey = 'Region';
                        newRow[newKey] = row[key];
                    }
                    return newRow;
                });
                
                const requiredHeaders = ['Umur', 'BMI', 'Jumlah Anak', 'Status Perokok', 'Gender', 'Region', 'Besar Klaim'];
                const firstRowHeaders = Object.keys(jsonData[0]);
                const missingHeaders = requiredHeaders.filter(rh => !firstRowHeaders.includes(rh));
                
                if (missingHeaders.length > 0) {
                    showAlert(`Kolom berikut tidak ditemukan: ${missingHeaders.join(', ')}`);
                    loadingDiv.style.display = 'none';
                    return;
                }
                
                const excludeAge = parseFloat(document.getElementById('excludeAgeInput').value) || Infinity;
                const excludeBmi = parseFloat(document.getElementById('excludeBmiInput').value) || Infinity;
                const excludeSmoker = document.getElementById('excludeSmokerInput').value === 'yes';

                const originalCount = jsonData.length;
                const filteredJsonData = jsonData.filter(row => {
                    const age = parseFloat(row.Umur);
                    const bmi = parseFloat(row.BMI);
                    const isSmoker = String(row['Status Perokok'])?.toLowerCase().includes('yes');
                    if (age > excludeAge) return false;
                    if (bmi > excludeBmi) return false;
                    if (excludeSmoker && isSmoker) return false;
                    return true;
                });
                
                const excludedCount = originalCount - filteredJsonData.length;
                exclusionSummaryDiv.style.display = excludedCount > 0 ? 'block' : 'none';
                exclusionSummaryDiv.textContent = `Berdasarkan kriteria Anda, ${excludedCount} dari ${originalCount} polis telah dikecualikan dari analisis ini.`;
                
                if (filteredJsonData.length < 9) {
                    showAlert(`Data yang tersisa setelah filter (${filteredJsonData.length} baris) tidak cukup. Dibutuhkan minimal 9 baris.`);
                    loadingDiv.style.display = 'none';
                    return;
                }
                
                const dataForRegression = filteredJsonData.map(row => ({
                    'Besar Klaim': parseFloat(row['Besar Klaim']),
                    'Umur': parseFloat(row['Umur']),
                    'BMI': parseFloat(row['BMI']),
                    'Jumlah Anak': parseFloat(row['Jumlah Anak']),
                    'Status Perokok': String(row['Status Perokok']),
                    'Gender': String(row['Gender']),
                    'Region': String(row['Region'])
                })).filter(row => !Object.values(row).some(v => v === undefined || (typeof v === 'number' && isNaN(v))));
                
                if (dataForRegression.length < 9) {
                    showAlert("Data valid yang tersisa tidak cukup untuk model regresi. Dibutuhkan minimal 9 baris data lengkap.");
                    loadingDiv.style.display = 'none';
                    return;
                }

                betaCoefficients = getLinearRegressionCoefficients(dataForRegression);
                if (!betaCoefficients) {
                    showAlert("Gagal menghitung model regresi. Data mungkin memiliki multikolinearitas sempurna. Coba dengan set data yang berbeda.");
                    loadingDiv.style.display = 'none';
                    return;
                }
                
                const statisticalSummaryContainer = document.getElementById('statistical-summary');
                statisticalSummaryContainer.innerHTML = '';
                const headersToAnalyze = ['Besar Klaim', 'Umur', 'BMI', 'Jumlah Anak'];
                headersToAnalyze.forEach(header => {
                    statisticalSummaryContainer.innerHTML += calculateAndDisplayStats(filteredJsonData, header);
                });

                // Get all parameters
                const deductible = parseFloat(document.getElementById('deductibleInput').value);
                const coInsuranceRate = parseFloat(document.getElementById('coInsuranceRateInput').value) / 100;
                const coInsuranceMax = parseFloat(document.getElementById('coInsuranceMaxInput').value);
                const reinsuranceRetention = parseFloat(document.getElementById('reinsuranceRetentionInput').value);
                const reinsuranceCoverRate = parseFloat(document.getElementById('reinsuranceCoverInput').value) / 100;
                const reimbursementCap = parseFloat(document.getElementById('reimbursementCapInput').value);
                const minMonthlyPremium = parseFloat(document.getElementById('minMonthlyPremiumInput').value);
                const maxMonthlyPremium = parseFloat(document.getElementById('maxMonthlyPremiumInput').value);

                // Initialize accumulators
                let totalPolicies = 0, totalAnnualPremium = 0, totalAbjfReClaim = 0, totalSehatPlusFinalClaim = 0;

                const simulatedData = filteredJsonData.map(row => {
                    const originalClaim = parseFloat(row['Besar Klaim']);
                    if (isNaN(originalClaim)) return null;

                    totalPolicies++;
                    
                    // Premium Calculation
                    const predictedClaim = predictClaim(parseFloat(row.Umur), parseFloat(row.BMI), parseFloat(row['Jumlah Anak']), String(row['Status Perokok']), String(row['Gender']), String(row['Region']));
                    let newMonthlyPremium = Math.max(minMonthlyPremium, Math.min(maxMonthlyPremium, predictedClaim / 12));
                    const newAnnualPremium = newMonthlyPremium * 12;
                    totalAnnualPremium += newAnnualPremium;
                    
                    // Claim Calculation Waterfall
                    const cappedClaim = Math.min(originalClaim, reimbursementCap);
                    const claimAfterDeductible = Math.max(0, cappedClaim - deductible);
                    const coInsuranceAmount = Math.min(claimAfterDeductible * coInsuranceRate, coInsuranceMax);
                    const insuredClaim = deductible + coInsuranceAmount;
                    const sehatPlusNetClaim = cappedClaim - insuredClaim;
                    
                    const surplus = Math.max(0, sehatPlusNetClaim - reinsuranceRetention);
                    const abjfReClaim = surplus * reinsuranceCoverRate;
                    const sehatPlusPortionOfSurplus = surplus * (1 - reinsuranceCoverRate);
                    const sehatPlusFinalClaim = Math.min(sehatPlusNetClaim, reinsuranceRetention) + sehatPlusPortionOfSurplus;
                    
                    totalAbjfReClaim += abjfReClaim;
                    totalSehatPlusFinalClaim += sehatPlusFinalClaim;

                    return { ...row,
                        'Premi (Bulanan)': formatCurrency(newMonthlyPremium),
                        'Premi Tahunan': formatCurrency(newAnnualPremium), // Added this column
                        'Klaim Akhir SehatPlus': formatCurrency(sehatPlusFinalClaim),
                        'Klaim ABJF Re': formatCurrency(abjfReClaim)
                    };
                }).filter(row => row !== null).sort((a, b) => parseFloat(b['Besar Klaim']) - parseFloat(a['Besar Klaim']));
                
                // Final Calculations
                const abjfReLossRatio = totalAnnualPremium > 0 ? (totalAbjfReClaim / totalAnnualPremium) * 100 : 0;
                const sehatPlusLossRatio = totalAnnualPremium > 0 ? (totalSehatPlusFinalClaim / totalAnnualPremium) * 100 : 0;
                const sehatPlusProfitLoss = totalAnnualPremium - totalSehatPlusFinalClaim;
                
                // Display simulation summary
                const simulationSummaryContainer = document.getElementById('simulation-summary');
                let modelTableHTML = `<h3 class="text-lg font-semibold mt-8 mb-2 text-gray-800">Model Regresi Linear</h3>
                        <p class="text-sm text-gray-600 mb-4">Model ini memprediksi besar klaim tahunan berdasarkan faktor risiko.</p>
                        <div class="overflow-x-auto"><table class="min-w-full text-sm text-left"><thead class="bg-gray-100"><tr>
                        <th class="p-2 font-medium">Variabel</th><th class="p-2 font-medium">Koefisien (Î²)</th><th class="p-2 font-medium">Interpretasi</th></tr></thead><tbody>`;
                
                const interpretations = {
                    'Intercept': 'Nilai dasar klaim.', 'Umur': 'Kenaikan klaim per tahun usia.', 'BMI': 'Kenaikan klaim per 1 poin BMI.',
                    'Jumlah Anak': 'Kenaikan klaim per anak.', 'Status Perokok (Ya)': 'Tambahan biaya klaim jika perokok.', 'Gender (Pria)': 'Tambahan biaya klaim jika pria.',
                };
                for(const key in betaCoefficients) {
                    modelTableHTML += `<tr class="border-b"><td class="p-2">${key}</td><td class="p-2 font-mono">${formatCurrency(betaCoefficients[key])}</td><td class="p-2">${interpretations[key] || `Perbedaan biaya vs region dasar.`}</td></tr>`;
                }
                modelTableHTML += `</tbody></table></div>`;

                simulationSummaryContainer.innerHTML = `
                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Ringkasan Finansial SehatPlus</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Total Premi Tahunan</p><p class="text-xl font-bold text-green-700">${formatCurrency(totalAnnualPremium)}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Total Klaim Akhir</p><p class="text-xl font-bold text-red-700">${formatCurrency(totalSehatPlusFinalClaim)}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Profit / Loss</p><p class="text-xl font-bold ${sehatPlusProfitLoss >= 0 ? 'text-green-700' : 'text-red-700'}">${formatCurrency(sehatPlusProfitLoss)}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Loss Ratio</p><p class="text-xl font-bold ${sehatPlusLossRatio > 80 ? 'text-red-700' : 'text-green-700'}">${sehatPlusLossRatio.toFixed(2)}%</p></div>
                    </div>

                    <h3 class="text-lg font-semibold mt-6 mb-2 text-gray-800">Ringkasan Reasuransi (ABJF Re)</h3>
                     <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Total Polis</p><p class="text-xl font-bold text-gray-800">${totalPolicies}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Total Premi Tahunan</p><p class="text-xl font-bold text-green-700">${formatCurrency(totalAnnualPremium)}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Total Klaim Ditanggung</p><p class="text-xl font-bold text-red-700">${formatCurrency(totalAbjfReClaim)}</p></div>
                         <div class="summary-card text-center"><p class="text-sm text-gray-600">Loss Ratio vs Premi</p><p class="text-xl font-bold ${abjfReLossRatio > 80 ? 'text-red-700' : 'text-green-700'}">${abjfReLossRatio.toFixed(2)}%</p></div>
                    </div>
                    ${modelTableHTML}
                `;
                MathJax.typesetPromise();

                // Display results table
                const resultsTableContainer = document.getElementById('results-table-container');
                const top100Data = simulatedData.slice(0, 100);
                if (top100Data.length > 0) {
                    const headers = ['Umur', 'BMI', 'Status Perokok', 'Region', 'Besar Klaim', 'Premi (Bulanan)', 'Premi Tahunan', 'Klaim Akhir SehatPlus', 'Klaim ABJF Re'];
                    let tableHTML = '<table class="min-w-full text-xs text-left"><thead><tr class="bg-gray-100">';
                    headers.forEach(h => tableHTML += `<th class="p-2 font-medium">${h}</th>`);
                    tableHTML += '</tr></thead><tbody>';
                    top100Data.forEach(row => {
                        tableHTML += '<tr class="border-b">';
                        headers.forEach(h => {
                            let val = row[h];
                            if (h === 'Besar Klaim') val = formatCurrency(parseFloat(val));
                            tableHTML += `<td class="p-2">${val !== undefined ? val : ''}</td>`;
                        });
                        tableHTML += '</tr>';
                    });
                    tableHTML += '</tbody></table>';
                    resultsTableContainer.innerHTML = tableHTML;
                }

                // Charts
                const regionCounts = filteredJsonData.reduce((acc, row) => {
                    const region = row.Region || 'Unknown';
                    acc[region] = (acc[region] || 0) + 1;
                    return acc;
                }, {});
                const regionCtx = document.getElementById('regionChart').getContext('2d');
                if (regionChartInstance) regionChartInstance.destroy();
                regionChartInstance = new Chart(regionCtx, { type: 'doughnut', data: {
                    labels: Object.keys(regionCounts),
                    datasets: [{ data: Object.values(regionCounts), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#6366f1', '#ec4899'] }]
                }});

                const claimValues = filteredJsonData.map(row => parseFloat(row['Besar Klaim'])).filter(v => !isNaN(v));
                const maxClaim = Math.max(...claimValues);
                const binWidth = Math.ceil(maxClaim / 15 / 1000) * 1000 || 1000;
                const bins = {};
                claimValues.forEach(val => {
                    const binStart = Math.floor(val / binWidth) * binWidth;
                    const binLabel = `${formatCurrency(binStart)}`;
                    bins[binLabel] = (bins[binLabel] || 0) + 1;
                });
                const histogramCtx = document.getElementById('claimsHistogram').getContext('2d');
                if (claimsHistogramInstance) claimsHistogramInstance.destroy();
                claimsHistogramInstance = new Chart(histogramCtx, { type: 'bar', data: {
                    labels: Object.keys(bins),
                    datasets: [{ label: 'Jumlah Polis', data: Object.values(bins), backgroundColor: '#60a5fa' }]
                }, options: { scales: { y: { beginAtZero: true }, x: { categoryPercentage: 1.0, barPercentage: 1.0 } } } });

            } catch (error) {
                loadingDiv.style.display = 'none';
                showAlert(`Terjadi kesalahan saat memproses file: ${error.message}`);
                console.error(error);
            }
            loadingDiv.style.display = 'none';
            mainContentDiv.style.display = 'block';
            calculatorSection.style.display = 'block';
        }

        function calculateIndividualPremium() {
           const individualLoadingDiv = document.getElementById('individual-loading');
            individualLoadingDiv.style.display = 'block';
            document.getElementById('individual-result').style.display = 'none';

            setTimeout(() => {
                const age = parseFloat(document.getElementById('individualAge').value);
                const bmi = parseFloat(document.getElementById('individualBMI').value);
                const children = parseFloat(document.getElementById('individualChildren').value);
                const smoker = document.getElementById('individualSmoker').value;
                const gender = document.getElementById('individualGender').value;
                const region = document.getElementById('individualRegion').value;

                const minMonthlyPremium = parseFloat(document.getElementById('minMonthlyPremiumInput').value);
                const maxMonthlyPremium = parseFloat(document.getElementById('maxMonthlyPremiumInput').value);

                if (!betaCoefficients) {
                    showAlert("Silakan unggah file dan klik 'Mulai Analisis' terlebih dahulu.");
                    individualLoadingDiv.style.display = 'none';
                    return;
                }

                if (isNaN(age) || isNaN(bmi) || isNaN(children)) {
                    showAlert("Pastikan semua input terisi dengan benar.");
                    individualLoadingDiv.style.display = 'none';
                    return;
                }

                const predictedClaim = predictClaim(age, bmi, children, smoker, gender, region);
                let monthlyPremium = predictedClaim / 12;
                monthlyPremium = Math.max(minMonthlyPremium, Math.min(maxMonthlyPremium, monthlyPremium));
                const annualPremium = monthlyPremium * 12;

                document.getElementById('predicted-monthly-premium').textContent = `Premi Bulanan: ${formatCurrency(monthlyPremium)}`;
                document.getElementById('predicted-annual-premium').textContent = `Premi Tahunan: ${formatCurrency(annualPremium)}`;
                document.getElementById('individual-result').style.display = 'block';
                individualLoadingDiv.style.display = 'none';
            }, 500);
        }
    </script>
</body>
</html>

